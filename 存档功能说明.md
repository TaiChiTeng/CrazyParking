# 微信小游戏存档功能说明

## 功能概述

本项目为CrazyParking游戏实现了完整的存档读档功能，支持微信小游戏云存储，确保不同设备上同一微信号的存档数据保持一致。

## 主要特性

- ✅ **云端存储**: 使用微信小游戏云开发，支持跨设备同步
- ✅ **本地备份**: 本地存储作为备用方案
- ✅ **10关循环**: 完成10关后自动从第1关重新开始
- ✅ **自动保存**: 通关时自动保存进度
- ✅ **数据验证**: 确保存档数据的完整性和有效性

## 文件结构

### 核心文件

```
assets/CoCoPark/GameScripts/
├── SaveManager.ts          # 存档管理器（核心）
├── GameManager.ts          # 游戏管理器（已集成存档功能）
├── CarManager.ts           # 汽车管理器（已支持异步通关检查）
└── SaveTest.ts             # 存档功能测试类
```

### 云函数

```
cloudfunctions/
├── saveGameData/           # 保存游戏数据
│   ├── index.js
│   └── package.json
├── loadGameData/           # 读取游戏数据
│   ├── index.js
│   └── package.json
└── clearGameData/          # 清除游戏数据
    ├── index.js
    └── package.json
```

## 使用方法

### 1. 云函数部署

在微信开发者工具中：

1. 打开云开发控制台
2. 创建云环境（如果还没有）
3. 上传并部署三个云函数：
   - `saveGameData`
   - `loadGameData` 
   - `clearGameData`

### 2. 游戏中的存档操作

#### Loading阶段初始化
- 游戏启动时在Loading场景中预先初始化存档系统
- 确保在进入游戏前完成存档系统准备

#### 自动存档
- 游戏会在每次通关时自动保存当前进度
- 无需手动操作

#### 读取存档
- 游戏启动时自动读取存档
- 如果有存档，从存档关卡开始
- 如果没有存档，从第1关开始

#### 手动清除存档（开发调试用）
```typescript
// 在GameManager中调用
await this.clearSaveData();
```

### 3. 测试存档功能

使用`SaveTest`组件进行功能测试：

```typescript
// 在场景中添加SaveTest组件，或手动调用
const saveTest = new SaveTest();
await saveTest.manualTest();
```

## 存档数据格式

```typescript
interface SaveData {
    currentLevel: number;    // 当前关卡（1-10循环）
    timestamp: number;       // 保存时间戳
    version: string;         // 存档版本
}
```

## 关卡循环逻辑

- 游戏共有10关
- 完成第10关后，下一关自动变为第1关
- 存档中的关卡始终保持在1-10范围内
- 支持无限循环游戏

## API 说明

### SaveManager 类

```typescript
class SaveManager {
    // 初始化存档管理器
    async init(): Promise<void>
    
    // 保存游戏进度
    async saveProgress(level: number): Promise<boolean>
    
    // 读取存档数据
    async loadSave(): Promise<SaveData | null>
    
    // 清除存档
    async clearSave(): Promise<boolean>
    
    // 验证并修正关卡数（支持10关循环）
    validateLevel(level: number): number
}
```

### GameManager 集成方法

```typescript
class GameManager {
    // 保存当前进度
    async saveCurrentProgress(): Promise<void>
    
    // 获取当前关卡
    getCurrentLevel(): number
    
    // 清除存档数据
    async clearSaveData(): Promise<void>
}
```

## 注意事项

1. **云函数权限**: 确保云函数有数据库读写权限
2. **网络环境**: 云存储需要网络连接，离线时使用本地存储
3. **数据同步**: 首次使用时可能需要等待云端数据同步
4. **版本兼容**: 存档数据包含版本信息，便于后续升级兼容
5. **容错处理**：系统具备完善的容错机制，即使云函数未部署或网络异常，本地存档功能仍可正常使用

## 容错处理机制

### 自动降级策略
- **云存储检测**：游戏启动时自动检测云存储可用性（5秒超时）
- **智能降级**：云存储不可用时自动切换到本地存储
- **双重备份**：云存储成功时同时备份到本地存储
- **超时保护**：所有云操作都有超时保护，避免长时间等待

### 错误处理
- **Loading阶段保护**：在游戏场景加载前完成存档系统初始化
- **网络异常**：自动重试并降级到本地存储
- **云函数未部署**：检测到云函数不存在时标记为不可用
- **数据损坏**：自动验证存档数据完整性
- **兼容性**：支持非微信环境下的本地存储
- **初始化失败保护**：即使存档初始化失败，游戏仍可正常运行

### 用户体验保障
- **无感知切换**：用户无需关心使用的是云存储还是本地存储
- **数据安全**：多重备份确保数据不丢失
- **快速响应**：超时机制确保游戏响应速度

## 故障排除

### 常见问题

1. **存档保存失败**
   - 检查网络连接
   - 确认云函数部署正确
   - 查看控制台错误信息

2. **存档读取失败**
   - 检查云函数权限配置
   - 确认数据库集合存在
   - 查看网络请求状态

3. **关卡循环异常**
   - 检查`validateLevel`方法逻辑
   - 确认关卡数据范围正确

### 调试方法

1. 使用`SaveTest`组件进行功能测试
2. 查看浏览器控制台日志
3. 检查云开发控制台的函数日志
4. 验证数据库中的存档记录

## 开发扩展

### 添加更多存档数据

可以在`SaveData`接口中添加更多字段：

```typescript
interface SaveData {
    currentLevel: number;
    timestamp: number;
    version: string;
    // 新增字段
    totalScore?: number;     // 总分数
    playTime?: number;       // 游戏时长
    achievements?: string[]; // 成就列表
}
```

### 支持多个存档槽

修改云函数，使用不同的`key`值：

```typescript
// 保存到不同槽位
await saveManager.saveProgress(level, 'slot1');
await saveManager.saveProgress(level, 'slot2');
```

## 更新日志

- **v1.0.0**: 初始版本，支持基本存档读档功能
- 支持微信小游戏云存储
- 实现10关循环逻辑
- 集成到现有游戏流程